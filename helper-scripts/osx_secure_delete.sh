#!/bin/zsh

GREEN="\033[01;32m"
YELLOW="\033[01;33m"
BLUE="\033[01;34m"
BOLD="\033[01;01m"
RED="\033[01;31m"
RESET="\033[00m"

PACKAGE="pwgen"
TMPDIR="tmp"
VOLUMENAME="SECURE_DELETE"
SIZEINMB=500

check_deps(){
if [ -d "/opt/homebrew/bin/$PACKAGE" ];then
printf "\n${GREEN}[+] Installing $PACKAGE ${RESET} \n"
brew install $PACKAGES 2>/dev/null && trueelse
else
printf "\n${BLUE}[+] $PACKAGE allready installed ${RESET} \n"
fi
}

check_tmp_dir(){
if [ -d $TMPDIR ];then
printf "\n${BLUE}[+] $TMPDIR allready existing ${RESET} \n"
else
printf "\n${GREEN}[+] Creating tmp folder ${RESET} \n"
mkdir $TMPDIR
fi
}

check_old_volume(){
if test -f "$TMPDIR/$VOLUMENAME.dmg"; then
echo "$VOLUMENAME exists! deleting $VOLUMENAME.dmg"
rm "$TMPDIR/$VOLUMENAME.dmg"
fi
}

#cd $TMPDIR
gen_password(){
printf "\n${GREEN}[+] Generating tmp Password for encryption ${RESET} \n"
printf $(pwgen -s 100) > $TMPDIR/tmp_pw.txt
}
create_enc_volume(){
printf "\n${GREEN}[+] Creating encrypted Volume ${RESET} \n"
printf '%s\0' $(cat $TMPDIR/tmp_pw.txt) | hdiutil create -megabytes $SIZEINMB -fs HFS+ -volname $VOLUMENAME "$TMPDIR"/"$VOLUMENAME"  -encryption AES-256  -stdinpass
}

mount_enc_volume(){
printf "\n${GREEN}[+] Mounting encrypted Volume ${RESET} \n"
printf '%s\0' $(cat $TMPDIR/tmp_pw.txt)  | hdiutil attach -stdinpass "$TMPDIR/$VOLUMENAME.dmg"
}
open_enc_volume(){
printf "\n${GREEN}[+] Open encrypted Volume ${RESET} \n"
open /Volumes/$VOLUMENAME
}

move_tmp_pw(){
printf "\n${GREEN}[+] Moving tmp_pw.txt 2 encrypted Volume ${RESET} \n"
mv $TMPDIR/tmp_pw.txt "/Volumes/"$VOLUMENAME
}

umount_and_delete() {
printf "\n${RED}[+] Umount encrypted Volume ${RESET} \n"
umount "/Volumes/"$VOLUMENAME
echo "\n${RED}[+] Deleting encrypted Volume ${RESET} \n"
rm "$TMPDIR"/"$VOLUMENAME.dmg"
}

get_decision() {
printf "\n${RED}Type (y) or (Y) or (n) or (N)  ${RESET} \n"
old_stty_cfg=$(stty -g)
stty raw -echo ; answer=$(head -c 1) ; stty $old_stty_cfg # Careful playing with stty
if echo "$answer" | grep -iq "^y" ;then
umount_and_delete
else
exit;
fi
}

check_deps && check_tmp_dir && check_old_volume && gen_password && create_enc_volume && sleep 3 && mount_enc_volume Der && open_enc_volume && move_tmp_pw && get_decision



