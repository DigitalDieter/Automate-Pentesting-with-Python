#!/bin/zsh

GREEN="\033[01;32m"
BLUE="\033[01;34m"
RED="\033[01;31m"
WHITEB="\033[01;37m"
RESET="\033[00m"

PACKAGE="pwgen"
TMPDIR="tmp"
VOLUMENAME="SECURE_DELETE"
SIZEINMB=1000


check_deps(){
if [[ $(command -v $PACKAGE) == "" ]]; then
printf "\n${GREEN}[+]${RESET}${WHITEB} Installing $PACKAGE ${RESET}\n"
brew install pwgen || arch -arm64 brew install pwgen
else
printf "\n${BLUE}[+]${RESET}${WHITEB} $PACKAGE allready existing ${RESET}\n"
fi
}

check_tmp_dir(){
if [ -d $TMPDIR ];then
printf "\n${BLUE}[+]${RESET}${WHITEB} $TMPDIR allready existing ${RESET}\n"
else
printf "\n${GREEN}[+]${RESET}${WHITEB} Creating tmp folder ${RESET}\n"
mkdir $TMPDIR
fi
}

check_old_volume(){
if test -f "$TMPDIR/$VOLUMENAME.dmg"; then
printf "\n${BLUE}[+]${RESET}${WHITEB} $VOLUMENAME exists! ! deleting $VOLUMENAME.dmg ${RESET}\n"
rm "$TMPDIR/$VOLUMENAME.dmg"
fi
}

#cd $TMPDIR
gen_password(){
printf "\n${GREEN}[+]${RESET}${WHITEB} Generating tmp Password for encryption ${RESET}\n"
printf $(pwgen -s 100) > $TMPDIR/tmp_pw.txt
}
create_enc_volume(){
printf "\n${GREEN}[+]${RESET}${WHITEB} Creating encrypted Volume ${RESET}\n"
printf '%s\0' $(cat $TMPDIR/tmp_pw.txt) | hdiutil create -megabytes $SIZEINMB -fs HFS+ -volname $VOLUMENAME "$TMPDIR"/"$VOLUMENAME"  -encryption AES-256  -stdinpass
}

mount_enc_volume(){
printf "\n${GREEN}[+]${RESET}${WHITEB} Mounting encrypted Volume ${RESET}\n"
printf '%s\0' $(cat $TMPDIR/tmp_pw.txt)  | hdiutil attach -stdinpass "$TMPDIR/$VOLUMENAME.dmg"
}
open_enc_volume(){
printf "\n${GREEN}[+]${RESET}${WHITEB} Open encrypted Volume ${RESET}\n"
open /Volumes/$VOLUMENAME
}

move_tmp_pw(){
printf "\n${GREEN}[+]${RESET}${WHITEB} Moving tmp_pw.txt 2 encrypted Volume${RESET}\n"
mv $TMPDIR/tmp_pw.txt "/Volumes/"$VOLUMENAME
}

umount_and_delete() {
printf "\n${GREEN}[+]${RESET}${WHITEB} Umount encrypted Volume ${RESET}\n"
umount "/Volumes/"$VOLUMENAME
printf "\n${GREEN}[+]${RESET}${WHITEB} Deleting encrypted Volume ${RESET}\n"
rm "$TMPDIR"/"$VOLUMENAME.dmg"
}


get_decision() {
printf "\n${WHITEB} To detach & delete type ${RESET}\n"
printf "\n${WHITEB} (y)(Y) or (n)(N)  ${RESET} \n"
old_stty_cfg=$(stty -g)
stty raw -echo ; answer=$(head -c 1) ; stty $old_stty_cfg # Careful playing with stty
if echo "$answer" | grep -iq "^y" ;then
umount_and_delete
else
printf "\n${RED}[+]${RESET}${WHITEB} The $VOLUMENAME volume is still mounted please unmount & delete manually  ${RESET}\n"
exit;
fi
}

check_deps && check_tmp_dir && check_old_volume && gen_password && create_enc_volume && sleep 3 && mount_enc_volume Der && open_enc_volume && move_tmp_pw && get_decision
